{% load i18n %}
{% load staticfiles %}

<template id="flow_status">
  <div>
    {% verbatim %}
    <div class="layout-breadcrumb">
      <breadcrumb>
        <breadcrumb-item><a @click="init({method: 'get', url: level_url.index}, 'flow')" title="go to flow list">{{cb_data.l0.text}}</a></breadcrumb-item>
        <breadcrumb-item v-if="level === 'stage'"><a @click="init({method: 'get', url: level_url.flow.replace('djst_var', cb_data.l1.url_id)}, 'stage')" title="refresh stage page">{{cb_data.l1.text}}</a></breadcrumb-item>
      </breadcrumb>
    </div>
    {% endverbatim %}
    <div class="layout-content">
      <div class="layout-content-main" style="background-image:url({% static 'images/background_1200x600.jpg' %})">
        <div>
          <i-input v-model="searchQuery" placeholder="Search" clearable style="width:200px"></i-input>
          <br>
          <i-table border stripe show-header :columns="table_col" :data="s_table_data" size="small" ref="table"></i-table>
          <div style="margin:10px; overflow:hidden">
            <div style="float:right">
              <Page :total="dataCount" :page-size="pageSize" show-total @on-change="changePage"></Page>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <div style="height:300px"></div> -->
  </div>
</template>

<script>
 Vue.component("flow_status", {
   template: "#flow_status",
   data: function () {
     return {
       table_data: [],
       col_ary: [],
       data_ary: [],
       filter_ary_obj: {},
       searchQuery: "",
       dataCount: 0,
       pageSize: 50,
       rsp_data: {},
       level: "",
       level_url: {
         index: "{% url 'flow_rpt:flow_status_list' %}" + "?user=" + this.$pCookie().user,
         flow: "{% url 'flow_rpt:flow_status_detail' 'djst_var' %}"
       },
       cur_data: [],
       cb_data: {
         l0: {},
         l1: {}
       }
     }
   },
   computed: {
     table_col: function () {
       var columns = []
       for (var i = 0; i < this.col_ary.length; i++) {
         columns.push(this.col_ary[i])
       }
       columns.push({
         title: "Action",
         key: "action",
         width: 150,
         align: "center",
         fixed: "right",
         render: (h, params) => {
           return h("div", [
             h("Button", {
               props: {
                 type: "primary",
                 size: "small"
               },
               style: {
                 marginRight: "5px"
               },
               on: {
                 click: () => {
                   this.show(params.index)
                 }
               }
             }, "View"),
             h("Button", {
               props: {
                 type: "error",
                 size: "small"
               },
               on: {
                 click: () => {
                   this.remove(params.index)
                 }
               }
             }, "Hide")
           ])
         }
       })
       return columns
     },
     s_table_data: function () {
       var searchQuery = this.searchQuery && this.searchQuery.toLowerCase()
       if (searchQuery) {
         data = this.table_data.filter(function (row) {
           return Object.keys(row).some(function (key) {
             return String(row[key]).toLowerCase().indexOf(searchQuery) > -1
           })
         })
       }
       else {
         data = this.table_data
       }
       return data
     }
   },
   methods: {
     init: function(ajax_cfg = {method: "get", url: this.level_url.index}, level = "flow") {
       axios(ajax_cfg).then((response) => {
         this.rsp_data = response.data
         this.level = level
         this.procLevel()
         this.procDataAry()
         this.procColAry()
         this.pageTableData()
       }).catch((error) => {
         console.log(error)
       })
     },
     procLevel: function () {
       if (this.level === "flow") {
         this.cur_data = this.rsp_data
         this.cb_data.l0.text = "flows"
       } else if (this.level === "stage") {
         this.cur_data = this.rsp_data.stage_flow
         this.cb_data.l0.text = this.rsp_data.block.proj.name + ":" + this.rsp_data.block.name + ":" + this.rsp_data.name
         this.cb_data.l1.url_id = this.rsp_data.id
         this.cb_data.l1.text = "stages"
       }
     },
     procColAry: function () {
       this.col_ary = []
       if (this.level === "flow") {
         this.col_ary.push({
           title: this.level + " name",
           key: "obj_name",
           /* "fixed": "left",*/
           width: 150,
           sortable: true,
           render: (h, params) => {
             const row = params.row
             const pk = row.obj_pk
             const text = row.obj_name
             return h("a", {
               on: {
                 click: () => {
                   this.init({
                     method: "get",
                     url: this.level_url[this.level].replace("djst_var", pk)}, "stage")
                 }
               }
             }, text)
           },
           filters: this.filter_ary_obj.obj_name,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.obj_name === value
           }
         })
       } else if (this.level === "stage") {
         this.col_ary.push({
           title: this.level + " name",
           key: "obj_name",
           /* "fixed": "left",*/
           width: 150,
           sortable: true,
           filters: this.filter_ary_obj.obj_name,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.obj_name === value
           }
         })
       }
       this.col_ary.push({
         title: "Owner",
         key: "owner",
         width: 150,
         sortable: true,
         filters: this.filter_ary_obj.owner,
         filterMultiple: true,
         filterMethod: function (value, row) {
           return row.owner === value
         }
       })
       this.col_ary.push({
         title: "Date",
         key: "created_time",
         width: 200,
         sortable: true,
         sortType: "desc"
       })
       this.col_ary.push({
         title: "Status",
         key: "status",
         width: 150,
         sortable: true,
         filters: this.filter_ary_obj.status,
         filterMultiple: true,
         filterMethod: function (value, row) {
           return row.status === value
         },
         render: (h, params) => {
           const row = params.row
           const color = row.status === "running" ? "yellow" : row.status === "passed" ? "green" : (row.status === undefined || row.status === "") ? "blue" : "red"
           const text = row.status
           return h("Tag", {
             props: {
               type: "dot",
               color: color
             }
           }, text)
         }
       })
       if (this.level === "flow") {
         this.col_ary.push({
           title: "Current Stage",
           key: "cur_stage",
           width: 200,
           sortable: true,
           filters: this.filter_ary_obj.cur_stage,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.cur_stage === value
           }
         })
         this.col_ary.push({
           title: "Comment",
           key: "comment",
           width: 200,
           sortable: true
         })
         this.col_ary.push({
           title: "Block",
           key: "block",
           width: 150,
           sortable: true,
           filters: this.filter_ary_obj.block,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.block === value
           }
         })
         this.col_ary.push({
           title: "Project",
           key: "proj",
           width: 150,
           sortable: true,
           filters: this.filter_ary_obj.proj,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.proj === value
           }
         })
       } else if (this.level === "stage") {
         this.col_ary.push({
           title: "Version",
           key: "version",
           width: 150,
           sortable: true,
           filters: this.filter_ary_obj.version,
           filterMultiple: true,
           filterMethod: function (value, row) {
             return row.version === value
           }
         })
       }
     },
     procDataAry: function () {
       this.data_ary = []
       this.filter_ary_obj = {obj_name: [], owner: [], status: []}
       var unique_ary_obj = {obj_name: [], owner: [], status: []}
       if (this.level === "flow") {
         this.filter_ary_obj.cur_stage = []
         this.filter_ary_obj.block = []
         this.filter_ary_obj.proj = []
         unique_ary_obj.cur_stage = []
         unique_ary_obj.block = []
         unique_ary_obj.proj = []
       } else if (this.level === "stage") {
         this.filter_ary_obj.version = []
         unique_ary_obj.version = []
       }
       for (var i = 0; i < this.cur_data.length; i++) {
         var qs_obj = this.cur_data[i]
         data_dic = {
           obj_pk: qs_obj.id,
           obj_name: qs_obj.name,
           created_time: qs_obj.created_time.slice(0, 19).replace("T", " "),
           status: qs_obj.status
         }
         if (this.level === "flow") {
           data_dic.cur_stage = qs_obj.cur_stage,
           data_dic.comment = qs_obj.comment,
           data_dic.block = qs_obj.block.name,
           data_dic.proj = qs_obj.block.proj.name
         } else if (this.level === "stage") {
           data_dic.version = qs_obj.version
         }
         if (qs_obj.owner === null) {
           data_dic.owner = "NA"
         } else {
           data_dic.owner = qs_obj.owner.name
         }
         for (var key in qs_obj.data) {
           data_dic[key] = qs_obj.data[key]
         }
         this.data_ary.push(data_dic)
         for (var key in this.filter_ary_obj) {
           if (unique_ary_obj[key].indexOf(data_dic[key]) === -1) {
             this.filter_ary_obj[key].push({"label": data_dic[key], "value": data_dic[key]})
             unique_ary_obj[key].push(data_dic[key])
           }
         }
       }
     },
     pageTableData: function () {
       this.dataCount = this.data_ary.length
       if (this.data_ary.length < this.pageSize) {
         this.table_data = this.data_ary
       } else {
         this.table_data = this.data_ary.slice(0, this.pageSize)
       }
     },
     changePage: function (index) {
       var _start = (index - 1) * this.pageSize
       var _end = index * this.pageSize
       this.table_data = this.data_ary.slice(_start, _end)
     },
     show: function (index) {
       var content = ""
       for (var td_key in this.table_data[index]) {
         content += td_key + ": " + this.table_data[index][td_key] + "<br>"
       }
       this.$Modal.info({
         title: "Detailed Info",
         content: content
       })
     },
     remove: function (index) {
       this.table_data.splice(index, 1)
     }
   },
   /* created: function () {
    * },*/
   mounted: function () {
     this.init()
   }
 })
</script>
