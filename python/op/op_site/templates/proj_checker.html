{% load i18n %}
{% load staticfiles %}

<template id="proj_checker">
  <div>
    {% verbatim %}
    <div class="layout-breadcrumb">
      <breadcrumb>
        <breadcrumb-item><a @click="init({method: 'get', url: level_url.index}, 'proj')" title="go to project list">{{cb_data.l0.text}}</a></breadcrumb-item>
        <breadcrumb-item v-if="level === 'detail'"><a @click="init({method: 'get', url: level_url.proj.replace('djst_var', cb_data.l1.url_id)}, 'detail')" title="refresh detail page">{{cb_data.l1.text}}</a></breadcrumb-item>
      </breadcrumb>
    </div>
    {% endverbatim %}
    <div class="layout-content">
      <div class="layout-content-main" style="background-image:url({% static 'images/background_1200x600.jpg' %})">
        <div v-if="level === 'detail'" style="background:#eee; padding:20px">
          <Card :bordered="false" style="font-family:monospace; color:black">
            {% verbatim %}
            <p slot="title">{{ cur_data.name }}</p>
            <p v-if="cur_data.lock || !edit_mode" v-html="cur_data.text"></p>
            <i-input v-else type="textarea" v-model="cur_data.text" element-id="proj_editor"></i-input>
            {% endverbatim %}
          </Card>
          <br>
          <div style="float:right">
            <i-button v-if="cur_data.lock" disabled type="primary">Locked</i-button>
            <div v-else-if="edit_mode">
              <i-button type="primary" @click="action_cancel">Cancel</i-button>
              <i-button type="primary" :loading="loading" icon="checkmark-round" @click="action_submit">
                <span v-if="!loading">Submit</span>
                <span v-else>Loading...</span>
              </i-button>
            </div>
            <i-button v-else type="primary" @click="action_edit">Edit</i-button>
          </div>
        </div>
        <div v-else>
          <i-form :label-width="200">
            <form-item label="Input Project to be ADDED">
              <i-input v-model="add_proj_name" placeholder="Enter project name" style="width:200px"></i-input>
              <i-button v-if="add_proj_name" type="success" @click="action_add(add_proj_name)">Add</i-button>
            </form-item>
            <form-item label="Select Project to be UPDATED">
              <i-select v-model="up_proj_index" clearable style="width:200px">
                {% verbatim %}
                <i-option v-for="(item, index) in cur_data" :value="index" :key="index">{{ item.name }}</i-option>
                {% endverbatim %}
              </i-select>
              <i-input v-if="up_proj_index in cur_data" v-model="cur_data[up_proj_index].data.owner" placeholder="Enter new owner name" style="width:200px"></i-input>
              <i-select v-if="up_proj_index in cur_data" v-model="cur_data[up_proj_index].data.status" clearable placeholder="Select status" style="width:200px">
                {% verbatim %}
                <i-option v-for="(item, index) in status_ary" :value="item" :key="index">{{ item }}</i-option>
                {% endverbatim %}
              </i-select>
              <i-button v-if="up_proj_index in cur_data && cur_data[up_proj_index].lock" disabled type="success">Locked</i-button>
              <i-button v-else-if="up_proj_index in cur_data" type="success" @click="action_up(up_proj_index)">Update</i-button>
            </form-item>
            <form-item label="Select Project to be DELETED">
              <i-select v-model="del_proj_index" clearable style="width:200px">
                {% verbatim %}
                <i-option v-for="(item, index) in cur_data" :value="index" :key="index">{{ item.name }}</i-option>
                {% endverbatim %}
              </i-select>
              {% verbatim %}
              {% endverbatim %}
              <i-button v-if="del_proj_index in cur_data && cur_data[del_proj_index].lock" disabled type="error">Locked</i-button>
              <i-button v-else-if="del_proj_index in cur_data" type="error" @click="action_del(del_proj_index)">Delete</i-button>
            </form-item>
          </i-form>
          <i-input v-model="searchQuery" placeholder="Search" clearable style="width:200px"></i-input>
          <br>
          <i-table border stripe show-header :columns="table_col" :data="s_table_data" size="small" ref="table"></i-table>
          <div style="margin:10px; overflow:hidden">
            <div style="float:right">
              <Page :total="dataCount" :page-size="pageSize" show-total @on-change="changePage"></Page>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <div style="height:300px"></div> -->
  </div>
</template>

<script>
 Vue.component("proj_checker", {
   template: "#proj_checker",
   data: function () {
     return {
       table_data: [],
       table_col: [],
       data_ary: [],
       filter_ary_obj: {},
       searchQuery: "",
       dataCount: 0,
       pageSize: 10,
       rsp_data: {},
       level: "",
       level_url: {
         index: "{% url 'proj_checker:proj_list' %}",
         proj: "{% url 'proj_checker:proj_detail' 'djst_var' %}",
         detail: ""
       },
       level_next: {
         index: "proj",
         proj: "detail",
         detail: ""
       },
       cur_data: [],
       cb_data: {
         l0: {},
         l1: {}
       },
       del_proj_index: "",
       add_proj_name: "",
       up_proj_index: "",
       status_ary: ["on-going", "completed", "pending", "canceled"],
       edit_mode: false,
       loading: false,
       lock_id_ary: []
     }
   },
   computed: {
     s_table_data: function () {
       var searchQuery = this.searchQuery && this.searchQuery.toLowerCase()
       if (searchQuery) {
         data = this.table_data.filter(function (row) {
           return Object.keys(row).some(function (key) {
             return String(row[key]).toLowerCase().indexOf(searchQuery) > -1
           })
         })
       }
       else {
         data = this.table_data
       }
       return data
     }
   },
   methods: {
     init: function(ajax_cfg = {method: "get", url: this.level_url.index}, level = "proj") {
       axios(ajax_cfg).then((response) => {
         this.rsp_data = response.data
         this.level = level
         for (var i = 0; i < this.lock_id_ary.length; i++) {
           this.patch_unlock(this.lock_id_ary[i])
         }
         this.lock_id_ary = []
         this.edit_mode = false,
         this.loading = false,
         this.procLevel()
         if (this.level !== "detail") {
           this.procDataAry()
           this.procColAry()
           this.pageTableData()
         }
       }).catch((error) => {
         console.log(error)
       })
     },
     procLevel: function () {
       this.cur_data = this.rsp_data
       if (this.level === "proj") {
         this.cb_data.l0.text = "projects"
         this.cur_data.sort(function (a, b) {
           return (a.name < b.name) ? -1 : (a.name > b.name) ? 1 : 0
         })
       } else if (this.level === "detail") {
         this.cb_data.l0.text = this.rsp_data.name
         this.cb_data.l1.url_id = this.rsp_data.id
         this.cb_data.l1.text = "details"
       }
     },
     procColAry: function () {
       this.table_col = [
         {
           title: this.level + " name",
           key: "obj_name",
           /* "fixed": "left",*/
           width: 200,
           sortable: true,
           sortType: "asc",
           render: (h, params) => {
             const row = params.row
             const pk = row.obj_pk
             const text = row.obj_name
             return h("a", {
               on: {
                 click: () => {
                   this.init({
                     method: "get",
                     url: this.level_url[this.level].replace("djst_var", pk)}, this.level_next[this.level])
                 }
               }
             }, text)
           }
         },
         {
           title: "Owner",
           key: "owner",
           width: 150,
           sortable: true
         },
         {
           title: "Latest Updated Time",
           key: "updated_time",
           width: 200,
           sortable: true
         },
         {
           title: "Status",
           key: "status",
           width: 150,
           sortable: true,
           render: (h, params) => {
             const row = params.row
             const color = row.status === "on-going" ? "yellow" : row.status === "completed" ? "green" : (row.status === undefined || row.status === "") ? "blue" : "red"
             const text = row.status
             return h("Tag", {
               props: {
                 type: "dot",
                 color: color
               }
             }, text)
           }
         },
         {
           title: "Locked",
           key: "lock",
           width: 200,
           sortable: true
         }
       ]
     },
     procDataAry: function () {
       this.data_ary = []
       for (var i = 0; i < this.cur_data.length; i++) {
         var qs_obj = this.cur_data[i]
         data_dic = {
           obj_pk: qs_obj.id,
           obj_name: qs_obj.name,
           updated_time: qs_obj.updated_time.slice(0, 19).replace("T", " "),
           lock: qs_obj.lock
         }
         for (var key in qs_obj.data) {
           data_dic[key] = qs_obj.data[key]
         }
         this.data_ary.push(data_dic)
       }
     },
     pageTableData: function () {
       this.dataCount = this.data_ary.length
       if (this.data_ary.length < this.pageSize) {
         this.table_data = this.data_ary
       } else {
         this.table_data = this.data_ary.slice(0, this.pageSize)
       }
     },
     changePage: function (index) {
       var _start = (index - 1) * this.pageSize
       var _end = index * this.pageSize
       this.table_data = this.data_ary.slice(_start, _end)
     },
     action_add: function (proj_name) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_name) {
         axios({
           method: "post",
           url: this.level_url.index,
           headers: {"X-CSRFToken": csrftoken},
           data: {
             name: proj_name,
             data: {
               owner: "",
               status: ""
             }
           }
         }).then((response) => {
           this.$Message.success("Project " + this.add_proj_name + " added!")
           this.add_proj_name = ""
           this.init()
         }).catch((error) => {
           console.log(error)
           if (error.response.status === 400) {
             this.$Message.error("Project " + this.add_proj_name + " exists!")
           }
         })
       }
     },
     action_up: function (proj_index) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_index in this.cur_data) {
         axios({
           method: "put",
           url: this.level_url.proj.replace("djst_var", this.cur_data[proj_index].id),
           headers: {"X-CSRFToken": csrftoken},
           data: {
             name: this.cur_data[proj_index].name,
             text: this.cur_data[proj_index].text,
             data: this.cur_data[proj_index].data
           }
         }).then((response) => {
           this.$Message.success("Project " + this.cur_data[proj_index].name + " updated!")
           this.up_proj_index = ""
           this.init()
         }).catch((error) => {
           console.log(error)
         })
       }
     },
     confirm_del: function (proj_id) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_id) {
         axios({
           method: "delete",
           url: this.level_url.proj.replace("djst_var", proj_id),
           headers: {"X-CSRFToken": csrftoken}
         }).then((response) => {
           this.del_proj_index = ""
           this.init()
         }).catch((error) => {
           console.log(error)
         })
       }
     },
     action_del: function (proj_index) {
       var content = ""
       for (var key in this.cur_data[proj_index]) {
         if (key === "text") {
           continue
         }
         var append_cont = ""
         if (key === "updated_time") {
           append_cont = this.cur_data[proj_index][key].slice(0, 19).replace("T", " ")
         } else if (key === "data") {
           append_cont = JSON.stringify(this.cur_data[proj_index][key])
         } else {
           append_cont = this.cur_data[proj_index][key]
         }
         content += key + ": " + append_cont + "<br>"
       }
       this.$Modal.confirm({
         title: "Delete Confirm",
         content: content,
         loading: true,
         onOk: () => {
           this.confirm_del(this.cur_data[proj_index].id)
           this.$Modal.remove()
           this.$Message.success("Project " + this.cur_data[proj_index].name + " deleted!")
         }
       })
     },
     action_edit: function () {
       var csrftoken = Cookies.get('csrftoken')
       axios({
         method: "get",
         url: this.level_url.proj.replace("djst_var", this.cur_data.id)
       }).then((response) => {
         this.cur_data = response.data
         if (!this.cur_data.lock) {
           axios({
             method: "patch",
             url: this.level_url.proj.replace("djst_var", this.cur_data.id),
             headers: {"X-CSRFToken": csrftoken},
             data: {
               lock: true
             }
           }).then((response) => {
             this.lock_id_ary.push(this.cur_data.id)
             this.edit_mode = !this.edit_mode
             if (this.edit_mode) {
               this.$nextTick(function () {
                 CKEDITOR.replace("proj_editor", {height: 450})
               })
             }
           }).catch((error) => {
             console.log(error)
           })
         }
       }).catch((error) => {
         console.log(error)
       })
     },
     patch_unlock: function (proj_id) {
       var csrftoken = Cookies.get('csrftoken')
       axios({
         method: "patch",
         url: this.level_url.proj.replace("djst_var", proj_id),
         headers: {"X-CSRFToken": csrftoken},
         data: {
           lock: false
         }
       }).then((response) => {
       }).catch((error) => {
         console.log(error)
       })
     },
     action_cancel: function () {
       this.edit_mode = false
       this.patch_unlock(this.cur_data.id)
     },
     action_submit: function () {
       this.cur_data.text = CKEDITOR.instances.proj_editor.getData()
       this.loading = true
       var csrftoken = Cookies.get('csrftoken')
       axios({
         method: "put",
         url: this.level_url.proj.replace("djst_var", this.cur_data.id),
         headers: {"X-CSRFToken": csrftoken},
         data: {
           name: this.cur_data.name,
           data: this.cur_data.data,
           text: this.cur_data.text
         }
       }).then((response) => {
         this.$Message.success("Project " + this.cur_data.name + " content submitted!")
         this.loading = false
         this.edit_mode = false
         this.patch_unlock(this.cur_data.id)
       }).catch((error) => {
         console.log(error)
       })
     }
   },
   /* created: function () {
    * },*/
   mounted: function () {
     this.init()
   },
   destroyed: function () {
     for (var i = 0; i < this.lock_id_ary.length; i++) {
       this.patch_unlock(this.lock_id_ary[i])
     }
     this.lock_id_ary = []
   }
 })
</script>
