{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load be_rpt_extras %}

{% block title %}
op platform --- alchip
{% endblock %}

{% block bc %}
<breadcrumb>
  {% if level == "proj" %}
  <breadcrumb-item>Projects</breadcrumb-item>
  {% elif level == "block" %}
  <breadcrumb-item><a href="{% url 'be_rpt:proj_list' %}" title="go to projects list">{{ proj_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item>blocks</breadcrumb-item>
  {% elif level == "version" %}
  <breadcrumb-item><a href="{% url 'be_rpt:proj_list' %}" title="go to projects list">{{ proj_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:block_list' proj_obj.pk %}" title="go to blocks list">{{ block_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item>versions</breadcrumb-item>
  {% elif level == "flow" %}
  <breadcrumb-item><a href="{% url 'be_rpt:proj_list' %}" title="go to projects list">{{ proj_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:block_list' proj_obj.pk %}" title="go to blocks list">{{ block_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:version_list' block_obj.pk %}" title="go to version list">{{ version_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item>flows</breadcrumb-item>
  {% elif level == "stage" %}
  <breadcrumb-item><a href="{% url 'be_rpt:proj_list' %}" title="go to projects list">{{ proj_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:block_list' proj_obj.pk %}" title="go to blocks list">{{ block_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:version_list' block_obj.pk %}" title="go to version list">{{ version_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item><a href="{% url 'be_rpt:flow_list' version_obj.pk %}" title="go to flow list">{{ flow_obj.name }}</a></breadcrumb-item>
  <breadcrumb-item>stages</breadcrumb-item>
  {% endif %}
</breadcrumb>
{% endblock %}

{% block content %}
<base_app :content_id="content_id"></base_app>
{% endblock %}

{% block template %}
<template id="base_app">
  <div v-if="content_id === 'index'" style="padding-left:40px; display:table-cell; vertical-align:middle; text-align:center; height:400px">
    <div>
      <img src="{% static 'images/alchip_190x98.png' %}">
    </div>
    <br>
    <br>
    <br>
    <div style="font-size:40px; color:DeepSkyBlue">
      Welcome to OnePiece Platform!
    </div>
  </div>
  <div v-else-if="content_id === 'be_rpt'">
    <div style="margin: 10px">
      Display border <i-switch v-model="showBorder" style="margin-right: 5px"></i-switch>
      Display stripe <i-switch v-model="showStripe" style="margin-right: 5px"></i-switch>
      Display index <i-switch v-model="showIndex" style="margin-right: 5px"></i-switch>
      Display multi choice <i-switch v-model="showCheckbox" style="margin-right: 5px"></i-switch>
      Display header <i-switch v-model="showHeader" style="margin-right: 5px"></i-switch>
      Table scrolling <i-switch v-model="fixedHeader" style="margin-right: 5px"></i-switch>
      <br>
      <br>
      Table size
      <Radio-group v-model="tableSize" type="button">
        <Radio label="large">large</Radio>
        <Radio label="default">medium</Radio>
        <Radio label="small">small(default)</Radio>
      </Radio-group>
    </div>
    <i-table :border="showBorder" :stripe="showStripe" :show-header="showHeader" :height="fixedHeader?300:''" :columns="table_col" :data="table_data" :size="tableSize" ref="table"></i-table>
    <div style="margin: 10px;overflow: hidden">
      <div style="float: right;">
        <Page :total="dataCount" :page-size="pageSize" show-total @on-change="changePage"></Page>
      </div>
    </div>
    <br>
    <i-button @click="handleSelectAll(true)">Set all selected</i-button>
    <i-button @click="handleSelectAll(false)">Cancel all selected</i-button>
    <i-button @click="deleteSelections()">Delete selected</i-button>
    <br>
    <br>
    <i-button type="primary" size="large" @click="exportData(1)"><icon type="ios-download-outline"></icon> Export source data</i-button>
    <i-button type="primary" size="large" @click="exportData(2)"><icon type="ios-download-outline"></icon> Export sorting and filtered data</i-button>
    <i-button type="primary" size="large" @click="exportData(3)"><icon type="ios-download-outline"></icon> Export custom data</i-button>
  </div>
</template>
{% endblock %}

{% block js %}
<script>
 Vue.component("base_app", {
   template: "#base_app",
   props: ["content_id"],
   data: function () {
     return {
       col_ary: [
         {
           {% if level == "proj" %}
           title: "Project Name",
           {% elif level == "block" %}
           title: "Block Name",
           {% elif level == "version" %}
           title: "Version Name",
           {% elif level == "flow" %}
           title: "Flow Name",
           {% elif level == "stage" %}
           title: "Stage Name",
           {% endif %}
           key: "obj_name",
           /* "fixed": "left",*/
           width: 200,
           sortable: true,
           render: (h, params) => {
             const row = params.row;
             const pk = row.obj_pk;
             const text = row.obj_name;
             return h("a", {
               attrs: {
                 {% if level == "proj" %}
                 href: "{% url 'be_rpt:block_list' 'djst_var' %}".replace("djst_var", pk)
                 {% elif level == "block" %}
                 href: "{% url 'be_rpt:version_list' 'djst_var' %}".replace("djst_var", pk)
                 {% elif level == "version" %}
                 href: "{% url 'be_rpt:flow_list' 'djst_var' %}".replace("djst_var", pk)
                 {% elif level == "flow" %}
                 href: "{% url 'be_rpt:stage_list' 'djst_var' %}".replace("djst_var", pk)
                 {% elif level == "stage" %}
                 href: "{% url 'be_rpt:stage_detail' 'djst_var' %}".replace("djst_var", pk)
                 {% endif %}
               }
             }, text);
           },
           filters: [
             {% for obj in name_distinct_lst %}
             {
               label: "{{ obj.name|escapejs }}",
               value: "{{ obj.name|escapejs }}"
             },
             {% endfor %}
           ],
           filterMultiple: true,
           filterMethod: function (value, row) {
             {% for obj in object_list %}
             {% if forloop.first %}
             if (value === "{{ obj.name|escapejs }}")
               {% else %}
             else if (value === "{{ obj.name|escapejs }}")
               {% endif %}
             return row.obj_name === "{{ obj.name|escapejs }}";
             {% endfor %}
           }
         },
         {
           title: "Owner",
           key: "owner",
           width: 150,
           sortable: true,
           filters: [
             {% for obj in owner_distinct_lst %}
             {
               label: "{{ obj.owner }}",
               value: "{{ obj.owner }}"
             },
             {% endfor %}
           ],
           filterMultiple: true,
           filterMethod: function (value, row) {
             {% for obj in object_list %}
             {% if forloop.first %}
             if (value === "{{ obj.owner }}")
               {% else %}
             else if (value === "{{ obj.owner }}")
               {% endif %}
             return row.owner === "{{ obj.owner }}";
             {% endfor %}
           }
         },
         {% if level == "version" or level == "flow" or level == "stage" %}
         {
           title: "Date",
           key: "created_time",
           width: 200,
           sortable: true,
         },
         {% endif %}
         {% if level == "block" %}
         {
           title: "Milestone",
           key: "milestone",
           width: 150,
           sortable: true,
           render: (h, params) => {
             const row = params.row;
             const ms_pk = row.ms_pk;
             const text = row.milestone;
             return h("a", {
               attrs: {
                 href: "{% url 'be_rpt:stage_detail' 'djst_var' %}".replace("djst_var", ms_pk)
               }
             }, text);
           }
         },
         {% endif %}
         {% for head in head_lst %}
         {% if head|to_lu == "status" %}
         {
           title: "Status",
           key: "{{ head|to_lu }}",
           width: 150,
           sortable: true,
           render: (h, params) => {
             const row = params.row;
             const color = row.status === "running" ? "yellow" : row.status === "passed" ? "green" : "red";
             const text = row.status
             return h("Tag", {
               props: {
                 type: "dot",
                 color: color
               }
             }, text);
           }
         },
         {% else %}
         {
           title: "{{ head }}",
           key: "{{ head|to_lu }}",
           width: 200,
           sortable: true,
         },
         {% endif %}
         {% endfor %}
       ],
       data_ary: [
         {% for obj in object_list %}
         {
           obj_pk: "{{ obj.pk }}",
           obj_name: "{{ obj.name|escapejs }}",
           owner: "{{ obj.owner }}",
           {% if level == "version" or level == "flow" or level == "stage" %}
           created_time: "{{ obj.created_time|date:'Y_m_d_H_i_s' }}",
           {% endif %}
           {% if level == "block" %}
           ms_pk: "{{ obj.milestone.pk }}",
           milestone: "{{ obj.milestone.name|escapejs }}",
           {% endif %}
           {% for head in head_lst %}
           {{ head|to_lu }}: "{{ obj.data|get_value:head|escapejs }}",
           {% endfor %}
           {% for obj_key, obj_value in obj.data.items %}
           {% if obj_key|to_lu not in head_lst %}
           {{ obj_key|to_lu }}: "{{ obj_value|escapejs }}",
           {% endif %}
           {% endfor %}
         },
         {% endfor %}
       ],
       table_data: [],
       showBorder: false,
       showStripe: false,
       showHeader: true,
       showIndex: false,
       showCheckbox: true,
       fixedHeader: false,
       tableSize: "small",
       dataCount: 0,
       pageSize: 10,
       qs_data: {},
     }
   },
   computed: {
     table_col: function () {
       var columns = [];
       if (this.showCheckbox) {
         columns.push({
           type: "selection",
           width: 60,
           align: "center"
         })
       }
       if (this.showIndex) {
         columns.push({
           type: "index",
           width: 60,
           align: "center"
         })
       }
       for (var i = 0; i < this.col_ary.length; i++)
         columns.push(this.col_ary[i]);
       columns.push({
         title: "Action",
         key: "action",
         width: 150,
         align: "center",
         fixed: "right",
         render: (h, params) => {
           return h("div", [
             h("Button", {
               props: {
                 type: "primary",
                 size: "small"
               },
               style: {
                 marginRight: "5px"
               },
               on: {
                 click: () => {
                   this.show(params.index)
                 }
               }
             }, "View"),
             h("Button", {
               props: {
                 type: "error",
                 size: "small"
               },
               on: {
                 click: () => {
                   this.remove(params.index)
                 }
               }
             }, "Delete"),
           ]);
         }
       });
       return columns;
     },
   },
   watch:{
     content_id: function () {
       console.log(this.content_id)
       if (this.content_id === "be_rpt") {
         axios.get("/be_rpt/block")
              .then(function (response) {
                console.log(response);
                this.qs_data = response.data
              })
              .catch(function (error) {
                console.log(error);
              });
       }
       this.procColAry();
       this.procDataAry();
       this.pageTableData();
     }
   },
   methods: {
     procColAry: function () {
     },
     procDataAry: function () {
       this.data_ary = []
       for (var i = 0; i < this.qs_data.qs_dic_lst.length; i++) {
         data_dic = {
           obj_pk: this.qs_data.qs_dic_lst[i].id,
           obj_name: this.qs_data.qs_dic_lst[i].name,
           owner: this.qs_data.qs_dic_lst[i].owner,
         };
         if (this.qs_data.level === "version" || this.qs_data.level === "flow" || this.qs_data.level === "stage")
           data_dic["created_time"] = this.qs_data.qs_dic_lst[i].created_time
         if (this.qs_data.level === "block") {
           /* data_dic["ms_pk"] = this.qs_data.qs_dic_lst[i].milestone.pk*/
         }
         this.data_ary.push(data_dic);
       };
     },
     pageTableData: function () {
       this.dataCount = this.data_ary.length;
       if (this.data_ary.length < this.pageSize) {
         this.table_data = this.data_ary;
       } else {
         this.table_data = this.data_ary.slice(0, this.pageSize);
       }
     },
     changePage: function (index) {
       var _start = (index - 1) * this.pageSize;
       var _end = index * this.pageSize;
       this.table_data = this.data_ary.slice(_start, _end);
     },
     exportData: function (type) {
       if (type === 1) {
         this.$refs.table.exportCsv({
           filename: "the_original_data"
         });
       } else if (type === 2) {
         this.$refs.table.exportCsv({
           filename: "sorting_and_filtering_data",
           original: false
         });
       } else if (type === 3) {
         this.$refs.table.exportCsv({
           filename: "custom_data",
           columns: this.table_col.filter((col, index) => index < this.table_col.length-1),
           data: this.table_data.filter((data, index) => index >= 0)
         });
       }
     },
     handleSelectAll: function (status) {
       this.$refs.table.selectAll(status);
     },
     deleteSelections: function () {
       var sel_dic = this.$refs.table.getSelection();
       for (var i = sel_dic.length-1; i >= 0; i--)
         this.table_data.splice(sel_dic[i], 1);
     },
     show: function (index) {
       var content = "";
       for (var td_key in this.table_data[index]) {
         content += td_key + ": " + this.table_data[index][td_key] + "<br>"
       }
       this.$Modal.info({
         title: "Detailed Info",
         content: content
       })
     },
     remove: function (index) {
       this.table_data.splice(index, 1);
     }
   },
   /* created: function () {
    *   this.pageTableData();
    * }*/
 })
</script>
{% endblock %}
