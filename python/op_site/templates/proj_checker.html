{% load i18n %}
{% load staticfiles %}

<template id="proj_checker">
  <div>
    {% verbatim %}
    <div class="layout-breadcrumb">
      <breadcrumb>
        <breadcrumb-item><a @click="procTable({method: 'get', url: level_url.index}, 'proj')" title="go to project list">{{cb_data.l0.text}}</a></breadcrumb-item>
        <breadcrumb-item v-if="level === 'detail'"><a @click="procTable({method: 'get', url: level_url.proj.replace('djst_var', cb_data.l1.url_id)}, 'detail')" title="refresh detail page">{{cb_data.l1.text}}</a></breadcrumb-item>
      </breadcrumb>
    </div>
    {% endverbatim %}
    <div class="layout-content">
      <div class="layout-content-main" style="background-image:url({% static 'images/background_1200x600.jpg' %})">
        <div v-if="level === 'detail'" style="background:#eee; padding:20px">
          <Card :bordered="false" style="font-family:monospace; color:black">
            {% verbatim %}
            <p slot="title">{{ cur_data.name }}</p>
            <i-input v-if="editable" type="textarea" v-model="cur_data.text" element-id="proj_editor"></i-input>
            <p v-else v-html="cur_data.text"></p>
            {% endverbatim %}
          </Card>
          <br>
          <div style="float:right">
            <div v-if="editable">
              <i-button type="primary" @click="toggle_edit">Cancel</i-button>
              <i-button type="primary" :loading="loading" icon="checkmark-round" @click="toggle_submit">
                <span v-if="!loading">Submit</span>
                <span v-else>Loading...</span>
              </i-button>
            </div>
            <div v-else>
              <i-button type="primary" @click="toggle_edit">Edit</i-button>
            </div>
          </div>
        </div>
        <div v-else>
          Input Project to be ADDED:
          <i-input v-model="add_proj_name" placeholder="Enter project name" style="width:200px"></i-input>
          <i-button v-if="add_proj_name" type="success" @click="toggle_add(add_proj_name)">Add</i-button>
          <br>
          Select Project Status to be UPDATED:
          <i-select v-model="up_proj_index" style="width:200px">
            {% verbatim %}
            <i-option v-for="(item, index) in cur_data" :value="index" :key="index">{{ item.name }}</i-option>
            {% endverbatim %}
          </i-select>
          <i-input v-if="up_proj_index !== ''" v-model="cur_data[up_proj_index].data.owner" placeholder="Enter new owner name" style="width:200px"></i-input>
          <i-select v-if="up_proj_index !== ''" v-model="cur_data[up_proj_index].data.status" placeholder="Select status" style="width:200px">
            {% verbatim %}
            <i-option v-for="(item, index) in status_ary" :value="item" :key="index">{{ item }}</i-option>
            {% endverbatim %}
          </i-select>
          <i-button v-if="up_proj_index !== ''" type="success" @click="toggle_up(up_proj_index)">Update</i-button>
          <br>
          {% verbatim %}
          <p>{{ up_proj_index }}</p>
          <p>{{ cur_data[up_proj_index] }}</p>
          {% endverbatim %}
          Select Project to be DELETED:
          <i-select v-model="del_proj_index" style="width:200px">
            {% verbatim %}
            <i-option v-for="(item, index) in cur_data" :value="index" :key="index">{{ item.name }}</i-option>
            {% endverbatim %}
          </i-select>
          {% verbatim %}
          {% endverbatim %}
          <i-button v-if="del_proj_index !== ''" type="error" @click="show_del_modal(del_proj_index)">Delete</i-button>
          <br>
          <br>
          <div style="margin:10px">
            Table size
            <Radio-group v-model="tableSize" type="button">
              <Radio label="large">large</Radio>
              <Radio label="default">medium</Radio>
              <Radio label="small">small(default)</Radio>
            </Radio-group>
          </div>
          <i-table border stripe show-header :columns="table_col" :data="table_data" :size="tableSize" ref="table"></i-table>
          <div style="margin:10px; overflow:hidden">
            <div style="float:right">
              <Page :total="dataCount" :page-size="pageSize" show-total @on-change="changePage"></Page>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <div style="height:300px"></div> -->
  </div>
</template>

<script>
 Vue.component("proj_checker", {
   template: "#proj_checker",
   data: function () {
     return {
       table_data: [],
       table_col: [],
       data_ary: [],
       filter_ary_obj: {},
       tableSize: "small",
       dataCount: 0,
       pageSize: 10,
       rsp_data: {},
       level: "",
       level_url: {
         index: "{% url 'proj_checker:proj_list' %}",
         proj: "{% url 'proj_checker:proj_detail' 'djst_var' %}",
         detail: ""
       },
       level_next: {
         index: "proj",
         proj: "detail",
         detail: ""
       },
       cur_data: [],
       cb_data: {
         l0: {},
         l1: {}
       },
       del_proj_index: "",
       add_proj_name: "",
       up_proj_index: "",
       status_ary: ["on-going", "completed", "pending", "canceled"],
       editable: false,
       loading: false
     }
   },
   methods: {
     init: function() {
       this.procTable({
         method: "get",
         url: this.level_url.index
       }, "proj")
     },
     procTable: function(ajax_cfg, level) {
       axios(ajax_cfg).then((response) => {
         this.rsp_data = response.data
         console.log(this.rsp_data)
         this.level = level
         this.editable = false,
         this.loading = false,
         this.procLevel()
         if (this.level !== "detail") {
           this.procDataAry()
           this.procColAry()
           this.pageTableData()
         }
       }).catch((error) => {
         console.log(error)
       })
     },
     procLevel: function () {
       this.cur_data = this.rsp_data
       if (this.level === "proj") {
         this.cb_data.l0.text = "projects"
         this.cur_data.sort(function (a, b) {
           return (a.name < b.name) ? -1 : (a.name > b.name) ? 1 : 0
         })
       } else if (this.level === "detail") {
         this.cb_data.l0.text = this.rsp_data.name
         this.cb_data.l1.url_id = this.rsp_data.id
         this.cb_data.l1.text = "details"
       }
     },
     procColAry: function () {
       this.table_col = [
         {
           title: this.level + " name",
           key: "obj_name",
           /* "fixed": "left",*/
           width: 200,
           sortable: true,
           sortType: "asc",
           render: (h, params) => {
             const row = params.row
             const pk = row.obj_pk
             const text = row.obj_name
             return h("a", {
               on: {
                 click: () => {
                   this.procTable({
                     method: "get",
                     url: this.level_url[this.level].replace("djst_var", pk)}, this.level_next[this.level])
                 }
               }
             }, text)
           }
         },
         {
           title: "Owner",
           key: "owner",
           width: 150,
           sortable: true
         },
         {
           title: "Latest Updated Time",
           key: "updated_time",
           width: 200,
           sortable: true
         },
         {
           title: "Status",
           key: "status",
           width: 150,
           sortable: true,
           render: (h, params) => {
             const row = params.row
             const color = row.status === "on-going" ? "yellow" : row.status === "completed" ? "green" : row.status === undefined ? "blue" : "red"
             const text = row.status
             return h("Tag", {
               props: {
                 type: "dot",
                 color: color
               }
             }, text)
           }
         }
       ]
     },
     procDataAry: function () {
       this.data_ary = []
       for (var i = 0; i < this.cur_data.length; i++) {
         var qs_obj = this.cur_data[i]
         data_dic = {
           obj_pk: qs_obj.id,
           obj_name: qs_obj.name,
           updated_time: qs_obj.updated_time.slice(0, 19).replace("T", " ")
         }
         for (var key in qs_obj.data) {
           data_dic[key] = qs_obj.data[key]
         }
         this.data_ary.push(data_dic)
       }
     },
     pageTableData: function () {
       this.dataCount = this.data_ary.length
       if (this.data_ary.length < this.pageSize) {
         this.table_data = this.data_ary
       } else {
         this.table_data = this.data_ary.slice(0, this.pageSize)
       }
     },
     changePage: function (index) {
       var _start = (index - 1) * this.pageSize
       var _end = index * this.pageSize
       this.table_data = this.data_ary.slice(_start, _end)
     },
     toggle_add: function (proj_name) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_name) {
         axios({
           method: "post",
           url: this.level_url.index,
           headers: {"X-CSRFToken": csrftoken},
           data: {
             name: proj_name,
             data: {
               owner: "",
               status: ""
             }
           }
         }).then((response) => {
           this.$Message.success("Project " + this.add_proj_name + " added!")
           this.add_proj_name = ""
           this.init()
         }).catch((error) => {
           console.log(error)
           if (error.response.status === 400) {
             this.$Message.error("Project " + this.add_proj_name + " exists!")
           }
         })
       }
     },
     toggle_up: function (proj_index) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_index !== "") {
         axios({
           method: "put",
           url: this.level_url.proj.replace("djst_var", this.cur_data[proj_index].id),
           headers: {"X-CSRFToken": csrftoken},
           data: {
             name: this.cur_data[proj_index].name,
             text: this.cur_data[proj_index].text,
             data: this.cur_data[proj_index].data
           }
         }).then((response) => {
           this.$Message.success("Project " + this.cur_data[proj_index].name + " updated!")
           this.up_proj_index = ""
           this.init()
         }).catch((error) => {
           console.log(error)
         })
       }
     },
     toggle_del: function (proj_id) {
       var csrftoken = Cookies.get('csrftoken')
       if (proj_id) {
         axios({
           method: "delete",
           url: this.level_url.proj.replace("djst_var", proj_id),
           headers: {"X-CSRFToken": csrftoken}
         }).then((response) => {
           this.del_proj_index = ""
           this.init()
         }).catch((error) => {
           console.log(error)
         })
       }
     },
     show_del_modal: function (proj_index) {
       var content = ""
       for (var key in this.cur_data[proj_index]) {
         if (key === "text") {
           continue
         }
         var append_cont = ""
         if (key === "updated_time") {
           append_cont = this.cur_data[proj_index][key].slice(0, 19).replace("T", " ")
         } else if (key === "data") {
           append_cont = JSON.stringify(this.cur_data[proj_index][key])
         } else {
           append_cont = this.cur_data[proj_index][key]
         }
         content += key + ": " + append_cont + "<br>"
       }
       this.$Modal.confirm({
         title: "Delete Confirm",
         content: content,
         loading: true,
         onOk: () => {
           this.toggle_del(this.cur_data[proj_index].id)
           this.$Modal.remove()
           this.$Message.success("Project " + this.cur_data[proj_index].name + " deleted!")
         }
       })
     },
     toggle_edit: function () {
       this.editable = !this.editable
       if (this.editable) {
         this.$nextTick(function () {
           CKEDITOR.replace("proj_editor", {})
         })
       }
     },
     toggle_submit: function () {
       this.cur_data.text = CKEDITOR.instances.proj_editor.getData()
       this.loading = true
       var csrftoken = Cookies.get('csrftoken')
       axios({
         method: "put",
         url: this.level_url.proj.replace("djst_var", this.cur_data.id),
         headers: {"X-CSRFToken": csrftoken},
         data: {
           name: this.cur_data.name,
           data: this.cur_data.data,
           text: this.cur_data.text
         }
       }).then((response) => {
         this.$Message.success("Project " + this.cur_data.name + " content submitted!")
         this.loading = false
         this.editable = false
       }).catch((error) => {
         console.log(error)
       })
     }
   },
   /* created: function () {
    * },*/
   mounted: function () {
     this.init()
   }
 })
</script>
